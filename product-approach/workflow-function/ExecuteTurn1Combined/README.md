# ExecuteTurn1Combined Lambda Function

This Lambda function combines multiple steps of the vending machine verification workflow into a single, optimized component. It handles system prompt preparation, turn 1 prompt preparation, and execution of the first conversation turn with Bedrock (Claude 3.7).

---

## Overview

**ExecuteTurn1Combined** streamlines the verification workflow by combining multiple steps:

1. Loads verification context and configuration from DynamoDB and S3
2. Prepares the system prompt with appropriate configuration
3. Prepares the turn 1 prompt with reference image (if available)
4. Executes the conversation with Bedrock using the shared client package
5. Processes and stores the response in S3
6. Updates verification status in DynamoDB
7. Returns lightweight references for downstream processing

---

## Key Architectural Features

- **Optimized Workflow Execution**:  
  - Reduces Step Functions state transitions by combining multiple Lambda functions
  - Minimizes cold start penalties and improves overall latency
  - Reduces API Gateway and Lambda invocation costs

- **Modular Service Architecture**:  
  - Clean separation of concerns with service interfaces
  - Dependency injection for better testability
  - Consistent error handling and logging

- **Shared Package Integration**:  
  - Leverages shared/bedrock for Bedrock API interactions
  - Uses shared/s3state for standardized state management
  - Implements shared/logger for structured logging
  - Utilizes shared/schema for consistent data structures

- **Enhanced Configuration**:  
  - Organized environment variables by functional area
  - Sensible defaults with comprehensive validation
  - Support for different storage modes and timeouts
  - Prompt templates are cached in memory for faster load times (set `TEMPLATE_CACHE_ENABLED=false` to disable)

---

## Directory Structure

```
ExecuteTurn1Combined/
├── cmd/
│   └── main.go              # Lambda handler entry point
├── internal/
│   ├── config/              # Configuration
│   │   └── config.go        # Environment config
│   ├── errors/              # Error handling
│   │   └── errors.go        # Error types and wrappers
│   ├── handler/             # Core business logic
│   │   └── handler.go       # Request coordination
│   ├── models/              # Data models
│   │   ├── bedrock.go       # Bedrock-related models
│   │   ├── request.go       # Request/response models
│   │   └── verification.go  # Verification state models
│   └── services/            # Service interfaces
│       ├── bedrock.go       # Bedrock service
│       ├── dynamodb.go      # DynamoDB service
│       ├── prompt.go        # Prompt service
│       └── s3.go            # S3 state service
├── Dockerfile               # Container build
├── go.mod                   # Go module definition
├── CHANGELOG.md             # Version history
└── README.md                # Documentation
```

---

## Configuration

The function uses these environment variables with sensible defaults:

| Variable                    | Description                           | Default                     |
|-----------------------------|---------------------------------------|----------------------------|
| **AWS Configuration**       |                                       |                            |
| AWS_REGION                  | AWS region for services               | us-east-1                  |
| STATE_BUCKET                | Bucket for S3 state storage           | (required)                  |
| BEDROCK_MODEL               | Claude model identifier               | (required)                  |
| ANTHROPIC_VERSION           | Anthropic API version                 | bedrock-2023-05-31          |
| DYNAMODB_VERIFICATION_TABLE | DynamoDB table for verification state | (required)                  |
| DYNAMODB_CONVERSATION_TABLE | DynamoDB table for conversation logs  | (required)                  |
| **Processing Configuration** |                                      |                            |
| MAX_TOKENS                  | Max tokens for response               | 24000                       |
| MAX_RETRIES                 | Max retry attempts                    | 3                           |
| BEDROCK_TIMEOUT_SECONDS     | Timeout for Bedrock calls             | 120                         |
| **Logging Configuration**   |                                       |                            |
| LOG_LEVEL                   | Logging level                         | INFO                        |
| LOG_FORMAT                  | Logging format                        | json                        |
| **Prompt Configuration**    |                                       |                            |
| TURN1_PROMPT_VERSION        | Turn 1 prompt template version        | v1.0                        |
| TEMPLATE_BASE_PATH          | Path to prompt templates              | /opt/templates              |
| TEMPLATE_CACHE_ENABLED    | Enable in-memory prompt cache          | true                       |

---

## Building and Deployment

### Local Build

```bash
go build -o main ./cmd/main.go
```

### Docker Build

```bash
docker build -t execute-turn1-combined .
```

### AWS Lambda Deployment

```bash
./retry-docker-build.sh --repo=<ECR_REPO_URI> --function=<LAMBDA_FUNCTION_NAME> --region=<AWS_REGION>
```

Required IAM permissions:
- `bedrock:InvokeModel` for the specified model
- `s3:GetObject` and `s3:PutObject` for the state bucket
- `dynamodb:GetItem`, `dynamodb:PutItem`, and `dynamodb:UpdateItem` for the DynamoDB tables

---

## Input and Output

### Input

```json
{
  "verificationId": "verif-12345",
  "verificationContext": {
    "machineId": "VM-12345",
    "location": "Store #123",
    "timestamp": "2025-05-19T12:34:56Z",
    "imageUrls": {
      "reference": "https://example.com/reference.jpg",
      "checking": "https://example.com/checking.jpg"
    },
    "metadata": {
      "productType": "snack",
      "expectedProduct": "Chips"
    }
  }
}
```

### Output

```json
{
  "verificationId": "verif-12345",
  "status": "TURN1_COMPLETED",
  "tokenUsage": {
    "inputTokens": 2500,
    "outputTokens": 1000,
    "thinkingTokens": 8000,
    "totalTokens": 11500
  },
  "responseReferences": {
    "rawResponse": {
      "bucket": "state-bucket",
      "key": "responses/verif-12345/turn1-raw-response.json"
    },
    "processedResponse": {
      "bucket": "state-bucket",
      "key": "responses/verif-12345/turn1-processed-response.json"
    }
  },
  "summary": {
    "latencyMs": 12500,
    "status": "TURN1_COMPLETED"
  }
}
```

## Error Handling

The function returns structured errors:

```json
{
  "status": "ERROR",
  "error": {
    "code": "BEDROCK_API_ERROR",
    "message": "Failed to call Bedrock API",
    "stage": "BEDROCK",
    "details": {
      "error": "Quota exceeded",
      "retryable": true
    }
  }
}
```

## Monitoring and Logging

All function activity is logged to CloudWatch Logs with structured JSON format:

```json
{
  "level": "info",
  "timestamp": "2025-05-19T12:34:56Z",
  "service": "vending-verification",
  "function": "ExecuteTurn1Combined",
  "correlationId": "req-abc123",
  "verificationId": "verif-12345",
  "step": "BedrockProcessing",
  "message": "Bedrock API call successful",
  "data": {
    "latencyMs": 12500,
    "tokenUsage": 11500,
    "modelId": "anthropic.claude-3-sonnet-20250219-v1:0"
  }
}
```

Key metrics to monitor:
- Bedrock API latency (average, p95, p99)
- S3 operation latency
- DynamoDB operation latency
- Error rates by error type
- Lambda duration and memory utilization

---

## Development

### Prerequisites

- Go 1.24+
- Docker
- AWS CLI configured with appropriate permissions
- S3 bucket for state storage
- DynamoDB tables for verification and conversation state

### Local Testing

```bash
# Set up environment variables
export STATE_BUCKET=my-state-bucket
export BEDROCK_MODEL=anthropic.claude-3-sonnet-20250219-v1:0
export AWS_REGION=us-east-1
export DYNAMODB_VERIFICATION_TABLE=verification-table
export DYNAMODB_CONVERSATION_TABLE=conversation-table

# Build and run locally
go build -o main ./cmd/main.go
./main
```                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                